// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
}

enum MembershipStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  PENDING
}

enum MembershipType {
  MONTHLY
  DAILY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  GCASH
  BANK_TRANSFER
  CASH
  CREDIT_CARD
  FREE_MEMBERSHIP
  DISCOUNT_COUPON
  OTHER
}

enum ReferralSource {
  WORD_OF_MOUTH
  SOCIAL_MEDIA
  ADS
  GOOGLE_MAPS
  WEBSITE_BLOGS
  INFLUENCER_CREATOR
  OTHER
}

enum PerkType {
  MEETING_ROOM_HOURS
  PRINTING_CREDITS
  EVENT_DISCOUNT
  LOCKER_ACCESS
  COFFEE_VOUCHERS
  PARKING_SLOTS
  GUEST_PASSES
  CUSTOM
}

enum MeetingRoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  INACTIVE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model User {
  id       String   @id // Format: YYYYNNN (e.g., 2025001, 2025002)
  email    String   @unique
  password String?
  name     String
  nickname String?
  role     UserRole @default(USER)
  isMember Boolean  @default(false)

  // Additional user info
  company           String?
  contactNumber     String?
  birthdate         DateTime?
  referralSource    ReferralSource?
  agreeToNewsletter Boolean         @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships         Membership[]
  eventRegistrations  EventRegistration[]
  payments            Payment[]
  dailyUseRedemptions DailyUseRedemption[]
  perkUsages          MembershipPerkUsage[]
  meetingRoomBookings MeetingRoomBooking[]

  @@index([email])
  @@index([isMember])
  @@map("users")
}

model Customer {
  id            String  @id @default(cuid())
  name          String
  email         String?
  contactNumber String?
  company       String?

  // Optional link to User if they later sign up
  userId String? @unique

  // Customer metadata
  notes          String?         @db.Text
  referralSource ReferralSource?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  eventRegistrations  CustomerEventRegistration[]
  payments            CustomerPayment[]
  dailyUseRedemptions CustomerDailyUseRedemption[]
  meetingRoomBookings CustomerMeetingRoomBooking[]

  @@index([email])
  @@index([contactNumber])
  @@index([userId])
  @@map("customers")
}

model MembershipPlan {
  id           String         @id @default(cuid())
  name         String // e.g., "Basic Monthly", "Premium Monthly", "Daily Pass"
  description  String?        @db.Text
  type         MembershipType
  price        Float
  durationDays Int // 1 for daily, 30 for monthly, etc.
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  perks       MembershipPlanPerk[]
  memberships Membership[]

  @@index([type])
  @@index([isActive])
  @@map("membership_plans")
}

model MembershipPlanPerk {
  id     String         @id @default(cuid())
  planId String
  plan   MembershipPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  perkType    PerkType
  name        String
  description String?  @db.Text
  quantity    Float
  unit        String

  // Optional limits
  maxPerDay  Float?
  maxPerWeek Float?

  // Day/time restrictions (for recurring perks like "Free Matcha Monday")
  daysOfWeek  String? // JSON array of days: ["MONDAY", "WEDNESDAY", "FRIDAY"]
  isRecurring Boolean @default(false)
  validFrom   String? // Time like "09:00"
  validUntil  String? // Time like "18:00"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Add relation to usage records
  usageRecords MembershipPerkUsage[]

  @@index([planId])
  @@index([perkType])
  @@map("membership_plan_perks")
}

model Membership {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Membership plan
  planId String?
  plan   MembershipPlan? @relation(fields: [planId], references: [id])

  // Membership details
  type      MembershipType   @default(MONTHLY)
  status    MembershipStatus @default(PENDING)
  startDate DateTime
  endDate   DateTime?

  // Billing info
  billingAddress String? @db.Text

  // Payment info
  paymentId String?  @unique
  payment   Payment? @relation(fields: [paymentId], references: [id])

  // Coupon usage
  couponId String?
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  perkUsages MembershipPerkUsage[]

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([type])
  @@map("memberships")
}

model MembershipPerkUsage {
  id           String     @id @default(cuid())
  membershipId String
  membership   Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Add perkId relation
  perkId String?
  perk   MembershipPlanPerk? @relation(fields: [perkId], references: [id], onDelete: Cascade)

  perkType     PerkType
  perkName     String
  quantityUsed Float // Amount used
  unit         String // e.g., "hours", "credits"

  meetingRoomBooking MeetingRoomBooking?

  usedAt DateTime @default(now())
  notes  String?  @db.Text

  // Optional: Link to what was used (meeting room booking, print job, etc.)
  referenceId   String?
  referenceType String? // e.g., "MEETING_ROOM_BOOKING", "PRINT_JOB"

  @@index([membershipId])
  @@index([perkId])
  @@index([perkType])
  @@index([usedAt])
  @@map("membership_perk_usages")
}

model Coupon {
  id            String    @id @default(cuid())
  code          String    @unique
  description   String?
  discountType  String // "PERCENTAGE" | "FIXED_AMOUNT" | "FREE"
  discountValue Float // Percentage (0-100) or fixed amount
  maxUses       Int? // Null means unlimited
  usedCount     Int       @default(0)
  isActive      Boolean   @default(true)
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  memberships Membership[]

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

model EventCategory {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Workshop", "Networking", "Social", "Training"
  slug        String   @unique // URL-friendly version
  description String?  @db.Text
  color       String? // Hex color for UI display (e.g., "#FF5733")
  icon        String? // Icon name or emoji
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  events Event[]

  @@index([slug])
  @@index([isActive])
  @@map("event_categories")
}

model Event {
  id               String   @id @default(cuid())
  title            String
  slug             String   @unique // Add this line
  description      String   @db.Text
  date             DateTime
  startTime        String?
  endTime          String?
  location         String?
  price            Float    @default(0)
  isFree           Boolean  @default(false)
  isMemberOnly     Boolean  @default(false)
  isFreeForMembers Boolean  @default(false)

  // Event category
  categoryId String?
  category   EventCategory? @relation(fields: [categoryId], references: [id])

  // Daily use redemption events
  isRedemptionEvent Boolean @default(false)
  redemptionLimit   Int?

  maxAttendees Int?
  imageUrl     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  registrations         EventRegistration[]
  customerRegistrations CustomerEventRegistration[]
  freebies              EventFreebie[]

  @@index([date])
  @@index([isFree])
  @@index([isMemberOnly])
  @@index([isRedemptionEvent])
  @@index([categoryId])
  @@index([slug]) // Add this line
  @@map("events")
}

model EventFreebie {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  description String?
  quantity    Int
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  paxFreebies         PaxFreebie[]
  customerPaxFreebies CustomerPaxFreebie[]

  @@index([eventId])
  @@map("event_freebies")
}

model EventRegistration {
  id      String @id @default(cuid())
  userId  String
  eventId String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Primary attendee (registrant)
  attendeeName  String?
  attendeeEmail String?

  // Number of pax (including primary attendee)
  numberOfPax Int @default(1)

  // Payment (if event is not free)
  paymentId String?  @unique
  payment   Payment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pax EventPax[] // Additional pax details

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@map("event_registrations")
}

model CustomerEventRegistration {
  id         String   @id @default(cuid())
  customerId String
  eventId    String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Primary attendee (registrant)
  attendeeName  String
  attendeeEmail String?
  attendeePhone String?

  // Number of pax (including primary attendee)
  numberOfPax Int @default(1)

  // Payment (if event is not free)
  paymentId String?          @unique
  payment   CustomerPayment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pax CustomerEventPax[] // Additional pax details

  @@unique([customerId, eventId])
  @@index([customerId])
  @@index([eventId])
  @@map("customer_event_registrations")
}

model EventPax {
  id             String            @id @default(cuid())
  registrationId String
  registration   EventRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  // Pax details
  name  String
  email String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  freebies PaxFreebie[]

  @@index([registrationId])
  @@map("event_pax")
}

model CustomerEventPax {
  id             String                    @id @default(cuid())
  registrationId String
  registration   CustomerEventRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  // Pax details
  name  String
  email String?
  phone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  freebies CustomerPaxFreebie[]

  @@index([registrationId])
  @@map("customer_event_pax")
}

model PaxFreebie {
  id        String       @id @default(cuid())
  paxId     String
  freebieId String
  pax       EventPax     @relation(fields: [paxId], references: [id], onDelete: Cascade)
  freebie   EventFreebie @relation(fields: [freebieId], references: [id], onDelete: Cascade)
  quantity  Int          @default(1)
  option   String?      
  createdAt DateTime     @default(now())

  @@unique([paxId, freebieId])
  @@index([paxId])
  @@index([freebieId])
  @@map("pax_freebies")
}

model CustomerPaxFreebie {
  id        String           @id @default(cuid())
  paxId     String
  freebieId String
  pax       CustomerEventPax @relation(fields: [paxId], references: [id], onDelete: Cascade)
  freebie   EventFreebie     @relation(fields: [freebieId], references: [id], onDelete: Cascade)
  quantity  Int              @default(1)
  option    String?
  createdAt DateTime         @default(now())

  @@unique([paxId, freebieId])
  @@index([paxId])
  @@index([freebieId])
  @@map("customer_pax_freebies")
}

model DailyUseRedemption {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId String

  // Redemption details
  redeemedAt DateTime @default(now())
  notes      String?  @db.Text

  @@index([userId])
  @@index([eventId])
  @@index([redeemedAt])
  @@map("daily_use_redemptions")
}

model CustomerDailyUseRedemption {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  eventId    String

  // Redemption details
  redeemedAt DateTime @default(now())
  notes      String?  @db.Text

  @@index([customerId])
  @@index([eventId])
  @@index([redeemedAt])
  @@map("customer_daily_use_redemptions")
}

model Payment {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Payment details
  amount        Float
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)

  // Internal payment reference (ev_kita2025_001)
  paymentReference String? @unique

  // User's payment reference (GCash/Bank reference number)
  referenceNumber String?

  // Payment proof
  proofImageUrl String?

  // Additional details
  notes String? @db.Text

  // Timestamps
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  eventRegistration EventRegistration?
  membership        Membership?
  meetingRoomBooking MeetingRoomBooking?

  @@index([userId])
  @@index([status])
  @@index([paymentReference])
  @@index([referenceNumber])
  @@map("payments")
}

model CustomerPayment {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Payment details
  amount        Float
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)

  // Internal payment reference (ev_kita2025_001)
  paymentReference String? @unique

  // User's payment reference (GCash/Bank reference number)
  referenceNumber String?

  // Payment proof
  proofImageUrl String?

  // Additional details
  notes String? @db.Text

  // Timestamps
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  eventRegistration CustomerEventRegistration?
  meetingRoomBooking CustomerMeetingRoomBooking?

  @@index([customerId])
  @@index([status])
  @@index([paymentReference])
  @@index([referenceNumber])
  @@map("customer_payments")
}

model AdminSettings {
  id String @id @default(cuid())

  // Bank Information
  bankName      String?
  accountNumber String?
  accountName   String?

  // QR Code for Payments
  qrCodeUrl    String?
  qrCodeNumber String? // Account number/phone number associated with QR

  // Only one settings record should exist
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_settings")
}

model MeetingRoom {
  id          String             @id @default(cuid())
  name        String             @unique
  description String?            @db.Text
  coverPhotoUrl String?          // Cloudinary URL
  
  // Pricing
  hourlyRate  Float
  
  // Capacity
  capacity    Int                // Maximum number of people
  
  // Availability
  startTime   String?            // "09:00" - Daily start time
  endTime     String?            // "18:00" - Daily end time
  
  // Amenities (stored as JSON array)
  amenities   String?            @db.Text // JSON: ["Projector", "Whiteboard", "WiFi"]
  
  // Status
  status      MeetingRoomStatus  @default(AVAILABLE)
  isActive    Boolean            @default(true)
  
  // Metadata
  floor       String?
  roomNumber  String?
  notes       String?            @db.Text
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  
  // Relations
  userBookings     MeetingRoomBooking[]
  customerBookings CustomerMeetingRoomBooking[]
  
  @@index([name])
  @@index([status])
  @@index([isActive])
  @@map("meeting_rooms")
}

// User Meeting Room Bookings
model MeetingRoomBooking {
  id          String        @id @default(cuid())
  
  // User relation
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Room relation
  roomId      String
  room        MeetingRoom   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  // Booking details
  bookingDate DateTime      // Date of booking
  startTime   String        // "09:00"
  endTime     String        // "12:00"
  duration    Float         // Hours (e.g., 3.0)
  
  // Attendees
  numberOfAttendees Int     @default(1)
  purpose     String?       @db.Text // Purpose of meeting
  
  // Status
  status      BookingStatus @default(PENDING)
  
  // Payment
  totalAmount Float         // Calculated: duration * hourlyRate
  paymentId   String?       @unique
  payment     Payment?      @relation(fields: [paymentId], references: [id])
  
  // Membership perk usage
  isUsingMembershipPerk Boolean @default(false)
  membershipPerkUsageId String? @unique
  perkUsage   MembershipPerkUsage? @relation(fields: [membershipPerkUsageId], references: [id])
  
  // Additional info
  notes       String?       @db.Text
  
  // Check-in/Check-out
  checkedInAt  DateTime?
  checkedOutAt DateTime?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([userId])
  @@index([roomId])
  @@index([bookingDate])
  @@index([status])
  @@map("meeting_room_bookings")
}

// Customer Meeting Room Bookings
model CustomerMeetingRoomBooking {
  id          String        @id @default(cuid())
  
  // Customer relation
  customerId  String
  customer    Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // Room relation
  roomId      String
  room        MeetingRoom   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  // Booking details
  bookingDate DateTime      // Date of booking
  startTime   String        // "09:00"
  endTime     String        // "12:00"
  duration    Float         // Hours (e.g., 3.0)
  
  // Attendees
  numberOfAttendees Int     @default(1)
  purpose     String?       @db.Text // Purpose of meeting
  contactPerson String      // Name of person booking
  contactEmail  String?
  contactPhone  String?
  
  // Status
  status      BookingStatus @default(PENDING)
  
  // Payment
  totalAmount Float         // Calculated: duration * hourlyRate
  paymentId   String?       @unique
  payment     CustomerPayment? @relation(fields: [paymentId], references: [id])
  
  // Additional info
  notes       String?       @db.Text
  
  // Check-in/Check-out
  checkedInAt  DateTime?
  checkedOutAt DateTime?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([customerId])
  @@index([roomId])
  @@index([bookingDate])
  @@index([status])
  @@map("customer_meeting_room_bookings")
}