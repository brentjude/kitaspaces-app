// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
}

enum MembershipStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  PENDING
}

enum MembershipType {
  MONTHLY
  DAILY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  GCASH
  BANK_TRANSFER
  CASH
  CREDIT_CARD
  FREE_MEMBERSHIP
  DISCOUNT_COUPON
  OTHER
}

enum ReferralSource {
  WORD_OF_MOUTH
  SOCIAL_MEDIA
  ADS
  GOOGLE_MAPS
  WEBSITE_BLOGS
  INFLUENCER_CREATOR
  OTHER
}

enum PerkType {
  MEETING_ROOM_HOURS
  PRINTING_CREDITS
  EVENT_DISCOUNT
  LOCKER_ACCESS
  COFFEE_VOUCHERS
  PARKING_SLOTS
  GUEST_PASSES
  CUSTOM
}

model User {
  id            String              @id // Format: YYYYNNN (e.g., 2025001, 2025002)
  email         String              @unique
  password      String?
  name          String
  nickname      String?
  role          UserRole            @default(USER)
  isMember      Boolean             @default(false)
  
  // Additional user info
  company       String?
  contactNumber String?
  birthdate     DateTime?
  referralSource ReferralSource?
  agreeToNewsletter Boolean        @default(false)
  
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // Relations
  memberships        Membership[]
  eventRegistrations EventRegistration[]
  payments           Payment[]
  dailyUseRedemptions DailyUseRedemption[]
  perkUsages         MembershipPerkUsage[]

  @@index([email])
  @@index([isMember])
  @@map("users")
}

model MembershipPlan {
  id            String   @id @default(cuid())
  name          String   // e.g., "Basic Monthly", "Premium Monthly", "Daily Pass"
  description   String?  @db.Text
  type          MembershipType
  price         Float
  durationDays  Int      // 1 for daily, 30 for monthly, etc.
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  perks         MembershipPlanPerk[]
  memberships   Membership[]

  @@index([type])
  @@index([isActive])
  @@map("membership_plans")
}

model MembershipPlanPerk {
  id          String   @id @default(cuid())
  planId      String
  plan        MembershipPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  perkType    PerkType
  name        String   // e.g., "Free Meeting Room Hours"
  description String?  @db.Text
  quantity    Float    // e.g., 4 for 4 hours, 100 for 100 prints
  unit        String   // e.g., "hours", "credits", "passes", "percentage"
  
  // Optional limits
  maxPerDay   Float?
  maxPerWeek  Float?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([planId])
  @@index([perkType])
  @@map("membership_plan_perks")
}

model Membership {
  id            String           @id @default(cuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Membership plan
  planId        String?
  plan          MembershipPlan?  @relation(fields: [planId], references: [id])
  
  // Membership details
  type          MembershipType   @default(MONTHLY)
  status        MembershipStatus @default(PENDING)
  startDate     DateTime
  endDate       DateTime?
  
  // Billing info
  billingAddress String?         @db.Text
  
  // Payment info
  paymentId     String?          @unique
  payment       Payment?         @relation(fields: [paymentId], references: [id])
  
  // Coupon usage
  couponId      String?
  coupon        Coupon?          @relation(fields: [couponId], references: [id])
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  perkUsages    MembershipPerkUsage[]

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([type])
  @@map("memberships")
}

model MembershipPerkUsage {
  id            String      @id @default(cuid())
  membershipId  String
  membership    Membership  @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  perkType      PerkType
  perkName      String
  quantityUsed  Float       // Amount used
  unit          String      // e.g., "hours", "credits"
  
  usedAt        DateTime    @default(now())
  notes         String?     @db.Text
  
  // Optional: Link to what was used (meeting room booking, print job, etc.)
  referenceId   String?
  referenceType String?     // e.g., "MEETING_ROOM_BOOKING", "PRINT_JOB"

  @@index([membershipId])
  @@index([userId])
  @@index([perkType])
  @@index([usedAt])
  @@map("membership_perk_usages")
}

model Coupon {
  id            String      @id @default(cuid())
  code          String      @unique
  description   String?
  discountType  String      // "PERCENTAGE" | "FIXED_AMOUNT" | "FREE"
  discountValue Float       // Percentage (0-100) or fixed amount
  maxUses       Int?        // Null means unlimited
  usedCount     Int         @default(0)
  isActive      Boolean     @default(true)
  expiresAt     DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  memberships   Membership[]

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

model Event {
  id            String              @id @default(cuid())
  title         String
  description   String              @db.Text
  date          DateTime
  startTime     String?
  endTime       String?
  location      String?
  price         Float               @default(0)
  isFree        Boolean             @default(false)
  isMemberOnly  Boolean             @default(false)
  isFreeForMembers Boolean          @default(false) // Free for members but paid for non-members
  
  // Daily use redemption events (e.g., Free Matcha Mondays)
  isRedemptionEvent Boolean          @default(false)
  redemptionLimit   Int?             // Max redemptions per user
  
  maxAttendees  Int?
  imageUrl      String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // Relations
  registrations EventRegistration[]
  freebies      EventFreebie[]

  @@index([date])
  @@index([isFree])
  @@index([isMemberOnly])
  @@index([isRedemptionEvent])
  @@map("events")
}

model EventFreebie {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  description String?
  quantity    Int
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  paxFreebies PaxFreebie[]

  @@index([eventId])
  @@map("event_freebies")
}

model EventRegistration {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  // Primary attendee (registrant)
  attendeeName  String?
  attendeeEmail String?
  
  // Number of pax (including primary attendee)
  numberOfPax   Int      @default(1)
  
  // Payment (if event is not free)
  paymentId     String?  @unique
  payment       Payment? @relation(fields: [paymentId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pax           EventPax[] // Additional pax details

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@map("event_registrations")
}

model EventPax {
  id             String            @id @default(cuid())
  registrationId String
  registration   EventRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  
  // Pax details
  name           String
  email          String?
  
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  freebies       PaxFreebie[]

  @@index([registrationId])
  @@map("event_pax")
}

model PaxFreebie {
  id        String       @id @default(cuid())
  paxId     String
  freebieId String
  pax       EventPax     @relation(fields: [paxId], references: [id], onDelete: Cascade)
  freebie   EventFreebie @relation(fields: [freebieId], references: [id], onDelete: Cascade)
  quantity  Int          @default(1)
  createdAt DateTime     @default(now())

  @@unique([paxId, freebieId])
  @@index([paxId])
  @@index([freebieId])
  @@map("pax_freebies")
}

model DailyUseRedemption {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId   String
  
  // Redemption details
  redeemedAt DateTime @default(now())
  notes      String?  @db.Text
  
  @@index([userId])
  @@index([eventId])
  @@index([redeemedAt])
  @@map("daily_use_redemptions")
}

model Payment {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Payment details
  amount            Float
  paymentMethod     PaymentMethod
  status            PaymentStatus @default(PENDING)
  referenceNumber   String?
  
  // Payment proof
  proofImageUrl     String?
  
  // Additional details
  notes             String?       @db.Text
  
  // Timestamps
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  eventRegistration EventRegistration?
  membership        Membership?

  @@index([userId])
  @@index([status])
  @@index([referenceNumber])
  @@map("payments")
}